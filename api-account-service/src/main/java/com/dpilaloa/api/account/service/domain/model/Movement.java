package com.dpilaloa.api.account.service.domain.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.UUID;

/**
 * DOMAIN MODEL: Movement (Entity)
 * <p>
 * Represents a transactional movement (debit/credit/reversal) on an account.
 * This is an Entity in Domain-Driven Design (DDD), belonging to the Account aggregate.
 * <p>
 * DESIGN PATTERNS APPLIED:
 * - Entity Pattern (DDD): Has unique identity (movementId) and lifecycle
 * - Immutable Pattern: Once created, movements cannot be modified (audit trail)
 * - Builder Pattern: Fluent object construction
 * <p>
 * SOLID PRINCIPLES:
 * - Single Responsibility: Only represents a transaction movement
 * - Open/Closed: Open for extension (new movement types) via enum
 * - Liskov Substitution: Can be substituted by any Movement type
 * <p>
 * BUSINESS RULES:
 * - Movement type must be DEBITO, CREDITO, or REVERSA
 * - Amount must be > 0 (positive)
 * - Stores balance before and after for audit trail
 * - Transaction ID ensures traceability
 * - Idempotency key prevents duplicate transactions
 * - Movements are IMMUTABLE (no updates allowed)
 * <p>
 * IMMUTABILITY:
 * - No UPDATE operations allowed
 * - Provides complete audit trail
 * - Ensures data integrity
 * <p>
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Movement {

    /**
     * Primary Key: UUID for movement ID
     * Auto-generated by database (uuid_generate_v4())
     */
    private UUID movementId;

    /**
     * Foreign Key: Reference to account
     * Links movement to its parent account (aggregate root)
     */
    private Long accountNumber;

    /**
     * Movement type: DEBITO (debit), CREDITO (credit), or REVERSA (reversal)
     * Uses enum for type safety and validation
     */
    private MovementType movementType;

    /**
     * Transaction amount (always positive)
     * For CREDITO: balance increases by this amount
     * For DEBITO: balance decreases by this amount
     */
    private BigDecimal amount;

    /**
     * Account balance BEFORE this movement
     * Used for audit trail and statement generation
     */
    private BigDecimal balanceBefore;

    /**
     * Account balance AFTER this movement
     * Used for audit trail and verification
     * BUSINESS RULE: balanceAfter = balanceBefore +/- amount
     */
    private BigDecimal balanceAfter;

    /**
     * Optional description of the movement
     */
    private String description;

    /**
     * Optional reference number
     */
    private String reference;

    /**
     * Unique transaction identifier for traceability
     * Format: TXN-{timestamp}-{random}
     */
    private String transactionId;

    /**
     * Reference to the original movement if this is a reversal
     * Only populated when movementType = REVERSA
     */
    private UUID reversedMovementId;

    /**
     * Indicates if this movement has been reversed
     * Default: false
     */
    private Boolean reversed;

    /**
     * Idempotency key to prevent duplicate transactions
     * Used in distributed systems to ensure exactly-once processing
     */
    private UUID idempotencyKey;

    /**
     * Audit timestamp: When movement was created
     * Auto-set by database DEFAULT CURRENT_TIMESTAMP
     * IMMUTABLE: Movements cannot be updated, only created
     */
    private LocalDateTime createdAt;

    /**
     * Correlation ID for distributed tracing
     * Links related operations across services
     */
    private UUID correlationId;

    /**
     * Request ID for request tracing
     * Unique identifier for the original request
     */
    private UUID requestId;

    // ========================================================================
    // BUSINESS METHODS (Domain Logic)
    // ========================================================================

    /**
     * Business Method: Verify balance calculation is correct
     * <p>
     * PATTERN: Self-Validation in Domain Model
     * SOLID: Single Responsibility - Movement validates its own consistency
     *
     * @return true if balanceAfter is correctly calculated
     */
    public boolean isBalanceCorrect() {
        BigDecimal expectedBalance = switch (movementType) {
            case CREDITO -> balanceBefore.add(amount);
            case DEBITO -> balanceBefore.subtract(amount);
            case REVERSA -> {
                // For reversal, the effect depends on the original movement type
                // This should be validated against the reversed_movement_id
                yield balanceAfter; // Simplified - actual calculation depends on original movement
            }
        };
        return balanceAfter.compareTo(expectedBalance) == 0;
    }

    /**
     * Business Method: Check if movement is a credit (deposit)
     *
     * @return true if movement type is CREDITO
     */
    public boolean isCredit() {
        return MovementType.CREDITO.equals(movementType);
    }

    /**
     * Business Method: Check if movement is a debit (withdrawal)
     *
     * @return true if movement type is DEBITO
     */
    public boolean isDebit() {
        return MovementType.DEBITO.equals(movementType);
    }

    /**
     * Business Method: Check if movement is a reversal
     *
     * @return true if movement type is REVERSA
     */
    public boolean isReversal() {
        return MovementType.REVERSA.equals(movementType);
    }

    /**
     * Business Method: Get the net effect on balance
     * Positive for credits, negative for debits
     *
     * @return +amount for CREDITO, -amount for DEBITO
     */
    public BigDecimal getNetEffect() {
        return isCredit() ? amount : amount.negate();
    }

    /**
     * Business Method: Format movement description for statements
     *
     * @return Human-readable description
     */
    public String getFormattedDescription() {
        String typeLabel = switch (movementType) {
            case CREDITO -> "Crédito";
            case DEBITO -> "Débito";
            case REVERSA -> "Reversa";
        };
        return String.format("%s de %s - Saldo anterior: %s, Saldo nuevo: %s",
            typeLabel,
            amount,
            balanceBefore,
            balanceAfter
        );
    }
}
